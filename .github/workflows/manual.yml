name: Auto Update data.json（自动读取标题）

on:
  push:
    paths:
      - 'setu/**'
      - 'zrsetu/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate data.json（自动提取标题）
        run: |
          cat > generate.js << 'EOF'
          const fs = require('fs');
          const path = require('path');

          function extractCaption(filePath) {
            try {
              const content = fs.readFileSync(filePath, 'utf8');
              const match = content.match(/<p[^>]*style=["'][^"']*text-align:\s*left[^"']*font-size:\s*16px[^>]*>(.*?)<\/p>/i);
              if (match && match[1]) {
                return match[1].replace(/<[^>]*>/g, '').trim();
              }
            } catch (e) {
              console.log('读取失败:', filePath, e.message);
            }
            return '';
          }

          function getItems(folder) {
            if (!fs.existsSync(folder)) return [];
            return fs.readdirSync(folder)
              .filter(f => f.endsWith('.html'))
              .map(file => ({
                file,
                caption: extractCaption(path.join(folder, file))
              }))
              .sort((a, b) => (parseInt(b.file) || 0) - (parseInt(a.file) || 0));
          }

          const data = {
            updated: new Date().toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'}).replace(/\//g, '-'),
            setu: getItems('setu'),
            zrsetu: getItems('zrsetu')
          };

          fs.writeFileSync('data.json', JSON.stringify(data, null, 2) + '\n');
          console.log(`成功生成 data.json，setu ${data.setu.length} 期，zrsetu ${data.zrsetu.length} 期`);
          'EOF'

          node generate.js

      - name: Commit & Push if changed
        run: |
          git config user.name "AutoBot"
          git config user.email "bot@github.com"
          git add data.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto update data.json（自动标题）" && git push)
