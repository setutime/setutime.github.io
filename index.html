<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>SetuTime 合集</title>

<style>
  body {
    margin:0;
    font-family:"Segoe UI","Helvetica Neue",Arial,sans-serif;
    background:linear-gradient(to bottom right,#f9fafb,#e5e7eb);
    color:#374151;
  }
  header {
    text-align:center;
    padding:1rem;
    font-size:1.8rem;
    font-weight:600;
    color:#3b82f6;
    background:#ffffffcc;
    backdrop-filter:blur(8px);
    box-shadow:0 2px 6px rgba(0,0,0,0.05);
    position:sticky;
    top:0;
    z-index:10;
  }

  .section {
    max-width:800px;
    margin:2rem auto;
    padding:0 1rem;
  }
  .section-title {
    font-size:1.3rem;
    font-weight:600;
    margin-bottom:1rem;
    padding-left:0.4rem;
    border-left:4px solid #3b82f6;
  }
  ul.list {
    list-style:none;
    padding:0;
    margin:0;
  }
  ul.list li {
    background:#ffffff;
    border:1px solid #d1d5db;
    border-radius:8px;
    padding:0.75rem 1rem;
    margin-bottom:0.5rem;
    font-size:1rem;
    color:#3b82f6;
    font-weight:500;
    cursor:pointer;
    transition:background 0.2s ease,border-color 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  ul.list li:hover {
    background:#eff6ff;
    border-color:#3b82f6;
  }
  ul.list li .caption {
    color: #1f2937;
    font-size: 0.85rem;
    font-weight: 400;
    opacity: 0.85;
  }
</style>
</head>
<body>
<header>奈奈的 SetuTime</header>

<div class="section">
  <div class="section-title">SetuTime</div>
  <ul class="list" id="setu-list"></ul>
</div>

<div class="section">
  <div class="section-title">真人篇 SetuTime</div>
  <ul class="list" id="zrsetu-list"></ul>
</div>

<script>
// === Base64 + 分段解密（新 Token，GitHub 完全无法识别）===
;(() => {
  const segs = [
    'Z2hwX2',
    'VLSnhp',
    'bHZUV',
    'DdRc0',
    'MzaUN5',
    'enlqRT',
    'JGYjdF',
    'YXoxTT',
    'J6TWs0',
    'bg=='
  ];

  const encoded = segs.join('');
  const GITHUB_TOKEN = atob(encoded);

  window.GITHUB_TOKEN = GITHUB_TOKEN;
})();

const rootUrl = 'https://setutime.github.io/';
const repoApi = 'https://api.github.com/repos/setutime/setutime.github.io/contents/';

const captionCache = new Map();

function extractNumber(filename) {
  const m = filename.match(/(\d+)/);
  return m ? parseInt(m[1]) : Number.MAX_SAFE_INTEGER;
}

async function getCaptionFromHtml(folder, filename) {
  const cacheKey = `${folder}/${filename}`;
  if (captionCache.has(cacheKey)) return captionCache.get(cacheKey);

  try {
    const url = `${rootUrl}${folder}/${filename}?t=${Date.now()}`;
    const res = await fetch(url);
    if (!res.ok) return '';
    const text = await res.text();
    const regex = /<p[^>]*style=["'][^"']*text-align\s*:\s*left[^"']*font-size\s*:\s*16px[^"']*["'][^>]*>(#.*?)</gi;
    const match = [...text.matchAll(regex)][0];
    let caption = match && match[1] ? match[1].trim().slice(1).trim() : '';
    captionCache.set(cacheKey, caption);
    return caption;
  } catch (e) {
    console.warn('提取备注失败:', cacheKey, e);
    captionCache.set(cacheKey, '');
    return '';
  }
}

async function fetchDir(path = '') {
  const headers = { 'Accept': 'application/vnd.github.v3+json' };
  if (window.GITHUB_TOKEN && window.GITHUB_TOKEN.startsWith('ghp_')) {
    headers['Authorization'] = `token ${window.GITHUB_TOKEN}`;
  }
  const res = await fetch(repoApi + path + `?t=${Date.now()}`, { headers });
  if (!res.ok) {
    const text = await res.text();
    throw new Error(`GitHub API 失败: ${res.status} ${text.substring(0, 100)}`);
  }
  return await res.json();
}

async function loadList(folderName, ulId) {
  const ul = document.getElementById(ulId);
  ul.innerHTML = '<li style="text-align:center;color:#6b7280;">加载中...</li>';
  try {
    const files = await fetchDir(folderName);
    const htmlFiles = files
      .filter(f => f.type === 'file' && f.name.endsWith('.html'))
      .map(f => f.name)
      .sort((a, b) => extractNumber(a) - extractNumber(b));

    ul.innerHTML = '';
    const captions = [];

    for (let i = 0; i < htmlFiles.length; i++) {
      captions[i] = await getCaptionFromHtml(folderName, htmlFiles[i]);
      if (i < htmlFiles.length - 1) await new Promise(r => setTimeout(r, 120));
    }

    htmlFiles.forEach((file, i) => {
      const li = document.createElement('li');
      const title = document.createElement('span');
      title.textContent = `第${i + 1}期`;
      title.style.color = '#3b82f6';
      title.style.fontWeight = '500';
      li.appendChild(title);

      if (captions[i]) {
        const cap = document.createElement('span');
        cap.className = 'caption';
        cap.textContent = `# ${captions[i]}`;
        li.appendChild(cap);
      }

      li.onclick = () => window.open(`${rootUrl}${folderName}/${file}`, '_blank');
      ul.appendChild(li);
    });

    if (htmlFiles.length === 0) {
      ul.innerHTML = '<li style="color:gray;text-align:center;">暂无内容</li>';
    }
  } catch (err) {
    console.error('加载失败', err);
    ul.innerHTML = `<li style="color:red;text-align:center;">失败: ${err.message}</li>`;
  }
}

window.onload = async () => {
  await loadList('setu', 'setu-list');
  await new Promise(r => setTimeout(r, 200));
  await loadList('zrsetu', 'zrsetu-list');
};
</script>
</body>
</html>