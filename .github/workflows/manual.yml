name: Auto Update data.json

on:
  push:
    paths:
      - 'setu/**'
      - 'zrsetu/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 生成 data.json
        run: |
          cat > generate.js << 'EOF'
          const fs = require('fs');
          const path = require('path');

          function extractCaptions(filePath, maxCount) {
            try {
              const content = fs.readFileSync(filePath, 'utf8');

              // 宽松匹配 style 中包含 text-align:left 和 font-size:16px 的 <p>
              const regex = /<p[^>]*style\s*=\s*["'][^"']*?\btext-align\s*:\s*left[^"']*?font-size\s*:\s*16px[^>]*>([\s\S]*?)<\/p>/gi;

              const captions = [];
              let match;
              while ((match = regex.exec(content)) !== null && captions.length < maxCount) {
                let text = match[1].replace(/<[^>]+>/g, '').trim();  // 只去除子标签，不动 # 或其他内容
                if (text) {
                  captions.push(text);
                }
              }
              return captions;
            } catch (e) {
              console.log(`读取失败 ${filePath}: ${e.message}`);
              return [];
            }
          }

          function getItems(folder, maxCaptions = 1) {
            if (!fs.existsSync(folder)) return [];
            return fs.readdirSync(folder)
              .filter(f => f.endsWith('.html'))
              .map(f => {
                const captions = extractCaptions(path.join(folder, f), maxCaptions);
                let caption = '';
                if (captions.length === 1) {
                  caption = captions[0];
                } else if (captions.length === 2 && maxCaptions === 2) {
                  caption = captions;  // 数组，只在 zrsetu 使用
                }
                // 0 或 >max 时为空字符串
                return {
                  file: f,
                  caption: caption
                };
              })
              .sort((a, b) => (parseInt(b.file) || 0) - (parseInt(a.file) || 0));
          }

          const data = {
            updated: new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' }).replace(/\//g, '-'),
            setu: getItems('setu', 1),      // 只取最多1行
            zrsetu: getItems('zrsetu', 2)  // 取最多2行
          };

          fs.writeFileSync('data.json', JSON.stringify(data, null, 2));
          console.log(`成功！setu ${data.setu.length}期，zrsetu ${data.zrsetu.length}期`);
          EOF

          node generate.js

      - name: 提交更新
        run: |
          git config user.name "AutoBot"
          git config user.email "bot@github.com"
          git add data.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto update data.json" && git push)
