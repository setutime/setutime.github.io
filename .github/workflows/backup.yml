name: Real-time Mirror to Backup

on:
  # 实时触发条件
  push:
    branches: [ main, master, develop ]
  pull_request:
    types: [closed]
    branches: [ main, master ]
  # 手动触发
  workflow_dispatch:

jobs:
  realtime-backup:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup SSH for Backup Account
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.BACKUP_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          echo "github.com ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOMqqnkVzrm0SdG6UOoqKLsabgH5C9okWi0dh2l9GKJl" >> ~/.ssh/known_hosts
          echo "github.com ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCj7ndNxQowgcQnjshcLrqPEiiphnt+VTTvDP6mHBL9j1aNUkY4Ue1gvwnGLVlOhGeYrnZaMgRK6+PKCUXaDbC7qtbW8gIkhL7aGCsOr/C56SJMy/BCZfxd1nWzAOxSDPgVsmerOBYfNqltV9/hWCqBywINIR+5dIg6JTJ72pcEpEjcYgXkE2YEFXV1JHnsKgbLWNlhScqb2UmyRkQyytRLtL+38TGxkxCflmO+5Z8CSSNY7GidjMIZ7Q4zMjA2n1nGrlTDkzwDCsw+wqFPGQA179cnfGWOWRVruj16z6XyvxvjJwbz0wQZ75XK5tKSb7FNyeIEs4TT4jk+S4dhPeAUC5y+bDYirYgM4GC7uEnztnZyaVWQ7B381AK4Qdrwt51ZqExKbQpTUNn+EjqoTwvqNj4kqx5QUCI0ThS/YkOxJCXmPUWZbhjpCg56i+2aB6CmK2JGhn57K5mj0MNdBXA4/WnwH6XoPWJzK5Nyu2zB3nAZp+S5hpQs+p1vN1/wsjk=" >> ~/.ssh/known_hosts

      - name: Configure Git Identity
        run: |
          git config --global user.name "Backup Bot"
          git config --global user.email "backup@github.com"

      - name: Real-time Push to Backup
        env:
          TARGET_REPO: "git@github.com:nnksetu/${{ github.event.repository.name }}.git"
        run: |
          # 添加备份远程
          git remote add backup $TARGET_REPO || true
          git remote set-url backup $TARGET_REPO
          
          # 获取所有远程分支
          git fetch origin
          
          # 推送当前分支
          CURRENT_BRANCH=${GITHUB_REF#refs/heads/}
          echo "正在推送分支: $CURRENT_BRANCH"
          
          # 强制推送确保同步
          git push backup $CURRENT_BRANCH --force
          
          # 推送所有标签
          git push backup --tags --force
          
          echo "✅ 实时同步完成: $(date)"
          echo "源仓库: ${{ github.repository }}"
          echo "目标仓库: nnksetu/${{ github.event.repository.name }}"
          echo "分支: $CURRENT_BRANCH"
          echo "提交: ${{ github.sha }}"

      - name: Verify Backup
        run: |
          echo "验证备份状态..."
          git ls-remote git@github.com:nnksetu/${{ github.event.repository.name }}.git HEAD
          echo "✅ 备份验证成功"
